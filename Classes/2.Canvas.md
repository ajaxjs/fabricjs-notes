# Canvas（画布）

FabricJS 的 Canvas 类是交互式画布的核心实现，支持对象选择、绘制和事件处理。它继承自 SelectableCanvas，并扩展了交互功能，如指针事件、触摸支持和绘制模式。

## 继承自（Extends）

+ `SelectableCanvas`（可选择画布）

## 构造函数（Constructors）

### new Canvas()

**new Canvas** ( `el` ?, `options` ?): `Canvas`

创建一个新的 Canvas 实例。

#### 参数（Parameters）

| 参数名  | 类型                            | 描述                                             | 是否可选 | 默认值 |
| ------- | ------------------------------- | ------------------------------------------------ | -------- | ------ |
| el      | `string` \| `HTMLCanvasElement` | Canvas 元素的 ID 或直接的 HTMLCanvasElement 对象 | 是       | -      |
| options | `TCanvasOptions`                | Canvas 配置选项                                  | 是       | `{}`   |

#### 返回值（Returns）

`Canvas` 实例

#### 覆盖（Overrides）

`SelectableCanvas.constructor`

#### 定义位置（Defined in）

src/canvas/Canvas.ts:117

**补充说明**：构造函数用于初始化画布元素。如果未提供 `el`，FabricJS 会创建一个新的 canvas 元素。`options` 可以配置画布的各种行为，如背景颜色、选择键等。建议在创建后调用 `renderAll()` 来渲染画布。

## 属性（Properties）

以下是 Canvas 类的属性列表，使用表格整理。每个属性包括类型、描述、继承来源（如果适用）和定义位置。

| 属性名                    | 类型                                                         | 描述                                                         |
| ------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| _activeObject?            | `FabricObject<Partial<FabricObjectProps>, SerializedObjectProps, ObjectEvents>` | 当前激活的对象（可选）                                       |
| _objects                  | `FabricObject<Partial<FabricObjectProps>, SerializedObjectProps, ObjectEvents>[]` | 对象数组（TODO: 需要移到构造函数中）                         |
| _offset                   | `object { left: number, top: number }`                       | 画布偏移量                                                   |
| allowTouchScrolling       | `boolean`                                                    | 是否允许触摸滚动（TODO: 移到 Canvas）                        |
| altActionKey              | `TOptionalModifierKey`                                       | 启用备选动作的键（'altKey', 'shiftKey', 'ctrlKey' 等）       |
| altSelectionKey           | `TOptionalModifierKey`                                       | 启用备选选择的键（仅在 preserveObjectStacking 为 true 时有效） |
| backgroundColor           | `string \| TFiller`                                          | 背景颜色                                                     |
| backgroundImage?          | `FabricObject<Partial<FabricObjectProps>, SerializedObjectProps, ObjectEvents>` | 背景图像（可选，支持图像缓存）                               |
| backgroundVpt             | `boolean`                                                    | 背景是否受视口变换影响（自 1.6.3 起）                        |
| centeredKey               | `TOptionalModifierKey`                                       | 启用居中变换的键                                             |
| centeredRotation          | `boolean`                                                    | 是否使用中心点作为旋转原点（自 1.3.4 起）                    |
| centeredScaling           | `boolean`                                                    | 是否使用中心点作为缩放原点（自 1.3.4 起）                    |
| clipPath?                 | `FabricObject<Partial<FabricObjectProps>, SerializedObjectProps, ObjectEvents>` | 剪裁路径对象（可选，用于定义剪裁区域）                       |
| containerClass            | `string`                                                     | 包装元素（div）的默认类名                                    |
| controlsAboveOverlay      | `boolean`                                                    | 控件是否在叠加层之上（TODO: 移到 Canvas）                    |
| defaultCursor             | `string`                                                     | 默认光标（默认: 'default'）                                  |
| destroyed?                | `boolean`                                                    | 是否已销毁（可选）                                           |
| disposed?                 | `boolean`                                                    | 是否已开始销毁过程（可选）                                   |
| elements                  | `CanvasDOMManager`                                           | DOM 管理器                                                   |
| enablePointerEvents       | `boolean`                                                    | 是否启用 PointerEvent 而非 TPointerEvent                     |
| enableRetinaScaling       | `boolean`                                                    | 是否启用 Retina 缩放                                         |
| fireMiddleClick           | `boolean`                                                    | 是否触发中键点击事件（自 1.7.8 起）                          |
| fireRightClick            | `boolean`                                                    | 是否触发右键点击事件（自 1.6.5 起）                          |
| freeDrawingBrush?         | `BaseBrush`                                                  | 自由绘制画刷（可选）                                         |
| freeDrawingCursor         | `string`                                                     | 自由绘制时的光标（默认: 'crosshair'）                        |
| height                    | `number`                                                     | 画布高度（逻辑像素）                                         |
| hoverCursor               | `string`                                                     | 悬停对象时的光标（默认: 'move'）                             |
| imageSmoothingEnabled     | `boolean`                                                    | 是否启用图像平滑                                             |
| includeDefaultValues      | `boolean`                                                    | toObject 是否包含默认值                                      |
| isDrawingMode             | `boolean`                                                    | 是否处于绘制模式                                             |
| moveCursor                | `string`                                                     | 移动对象时的光标（默认: 'move'）                             |
| notAllowedCursor          | `string`                                                     | 禁用元素的光标（自 2.0.0 起，默认: 'not-allowed'）           |
| overlayColor              | `string \| TFiller`                                          | 叠加颜色（自 1.3.9 起）                                      |
| overlayImage?             | `FabricObject<Partial<FabricObjectProps>, SerializedObjectProps, ObjectEvents>` | 叠加图像（可选，支持图像缓存）                               |
| overlayVpt                | `boolean`                                                    | 叠加是否受视口变换影响（自 1.6.3 起）                        |
| perPixelTargetFind        | `boolean`                                                    | 是否按像素检测对象                                           |
| preserveObjectStacking    | `boolean`                                                    | 选中时是否保持对象栈顺序                                     |
| renderOnAddRemove         | `boolean`                                                    | 添加/移除对象时是否渲染                                      |
| selection                 | `boolean`                                                    | 是否启用组选择                                               |
| selectionBorderColor      | `string`                                                     | 选择边框颜色                                                 |
| selectionColor            | `string`                                                     | 选择颜色                                                     |
| selectionDashArray        | `number[]`                                                   | 选择边框虚线数组                                             |
| selectionFullyContained   | `boolean`                                                    | 选择是否仅包含完全在矩形内的形状                             |
| selectionKey              | `TOptionalModifierKey \| ( "altKey" \| "shiftKey" \| "ctrlKey" \| "metaKey" )[]` | 启用多选的键                                                 |
| selectionLineWidth        | `number`                                                     | 选择线宽                                                     |
| skipOffscreen             | `boolean`                                                    | 是否跳过视口外对象渲染（默认: true）                         |
| skipTargetFind            | `boolean`                                                    | 是否跳过目标检测                                             |
| stopContextMenu           | `boolean`                                                    | 是否停止上下文菜单（自 1.6.5 起）                            |
| svgViewportTransformation | `boolean`                                                    | SVG 导出是否应用视口变换                                     |
| targetFindTolerance       | `number`                                                     | 目标检测容差                                                 |
| targets                   | `FabricObject<Partial<FabricObjectProps>, SerializedObjectProps, ObjectEvents>[]` | 鼠标事件的子目标数组（默认: []）                             |
| textEditingManager        | `TextEditingManager`                                         | 文本编辑管理器                                               |
| uniScaleKey               | `TOptionalModifierKey`                                       | 切换统一缩放的键                                             |
| uniformScaling            | `boolean`                                                    | 是否允许单侧变换（自 fabric 4.0 起）                         |
| viewportTransform         | `TMat2D`                                                     | 视口变换矩阵                                                 |
| vptCoords                 | `TCornerPoint`                                               | 视口坐标（见 calcViewportBoundaries）                        |
| width                     | `number`                                                     | 画布宽度（逻辑像素）                                         |
| ownDefaults               | `static TOptions<CanvasOptions>`                             | 默认配置（静态）                                             |

**补充说明**：属性大多继承自 SelectableCanvas 或 StaticCanvas。一些属性如 `backgroundImage` 支持缓存以提升性能。`viewportTransform` 用于缩放和平移画布，影响渲染。

## 访问器（Accessors）

访问器是 getter 方法，用于获取计算属性。以下表格整理访问器。

| 访问器名         | 返回类型                   | 描述                           | 定义位置                           |
| ---------------- | -------------------------- | ------------------------------ | ---------------------------------- |
| contextContainer | `CanvasRenderingContext2D` | 获取容器上下文                 | src/canvas/StaticCanvas.ts:141     |
| contextTop       | `CanvasRenderingContext2D` | 获取顶部上下文                 | src/canvas/SelectableCanvas.ts:298 |
| lowerCanvasEl    | `HTMLCanvasElement`        | 获取底层 canvas 元素（不可写） | src/canvas/StaticCanvas.ts:137     |
| upperCanvasEl    | `HTMLCanvasElement`        | 获取上层 canvas 元素           | src/canvas/SelectableCanvas.ts:295 |
| wrapperEl        | `HTMLDivElement`           | 获取包装元素                   | src/canvas/SelectableCanvas.ts:301 |

**补充说明**：这些访问器主要用于访问 DOM 元素和上下文。`lowerCanvasEl` 用于渲染对象，`upperCanvasEl` 用于交互层。

## 方法（Methods）

以下是方法列表，使用表格整理参数和描述。每个方法包括返回类型、描述、继承来源（如果适用）和定义位置。

| 方法名                     | 参数                                                         | 返回类型                               | 描述                                 |
| -------------------------- | ------------------------------------------------------------ | -------------------------------------- | ------------------------------------ |
| __onMouseWheel             | `e: TPointerEvent`                                           | `void`                                 | 处理鼠标滚轮事件                     |
| _basicEventHandler         | `eventType: T`, `options: CanvasEvents & ObjectEvents[T]`    | `CanvasEvents & ObjectEvents[T]`       | 基本事件处理器                       |
| _chooseObjectsToRender     | 无                                                           | `FabricObject[]`                       | 分组渲染对象                         |
| _discardActiveObject       | `e?: TPointerEvent`, `object?: FabricObject`                 | `this is Object`                       | 丢弃激活对象（不触发事件）           |
| _onStackOrderChanged       | 无                                                           | `void`                                 | 栈顺序变化回调                       |
| _set                       | `key: string`, `value: any`                                  | `void`                                 | 设置属性                             |
| _setActiveObject           | `object: FabricObject`, `e?: TPointerEvent`                  | `boolean`                              | 设置激活对象（不触发事件）           |
| _setCursorFromEvent        | `e: TPointerEvent`, `target?: FabricObject`                  | `void`                                 | 根据事件设置光标                     |
| absolutePan                | `point: Point`                                               | `void`                                 | 绝对平移视口                         |
| add                        | `...objects: FabricObject[]`                                 | `number`                               | 添加对象                             |
| addOrRemove                | `functor: any`, `_eventjsFunctor: "add" \| "remove"`         | `void`                                 | 添加或移除事件                       |
| bringObjectForward         | `object: FabricObject`, `intersecting?: boolean`             | `boolean`                              | 前移对象                             |
| bringObjectToFront         | `object: FabricObject`                                       | `boolean`                              | 移到最前                             |
| calcOffset                 | 无                                                           | `object { left: number, top: number }` | 计算画布偏移                         |
| calcViewportBoundaries     | 无                                                           | `TCornerPoint`                         | 计算视口边界                         |
| cancelRequestedRender      | 无                                                           | `void`                                 | 取消渲染请求                         |
| centerObject               | `object: FabricObject`                                       | `void`                                 | 居中对象                             |
| centerObjectH              | `object: FabricObject`                                       | `void`                                 | 水平居中                             |
| centerObjectV              | `object: FabricObject`                                       | `void`                                 | 垂直居中                             |
| clear                      | 无                                                           | `void`                                 | 清空画布（覆盖，清除文本编辑管理器） |
| clearContext               | `ctx: CanvasRenderingContext2D`                              | `void`                                 | 清空上下文                           |
| clone                      | `properties?: string[]`                                      | `Promise<Canvas>`                      | 克隆画布                             |
| cloneWithoutData           | 无                                                           | `Canvas`                               | 克隆画布（无数据）                   |
| collectObjects             | `bbox: TBBox`, `options = { includeIntersecting?: boolean }` | `InteractiveFabricObject[]`            | 收集边界框内对象                     |
| complexity                 | 无                                                           | `number`                               | 复杂度                               |
| contains                   | `object: FabricObject`, `deep?: boolean`                     | `boolean`                              | 是否包含对象                         |
| createSVGClipPathMarkup    | `options: TSVGExportOptions`                                 | `string`                               | 创建 SVG 剪裁路径标记                |
| createSVGFontFacesMarkup   | 无                                                           | `string`                               | 创建 SVG 字体标记                    |
| createSVGRefElementsMarkup | 无                                                           | `string`                               | 创建 SVG 引用元素标记                |
| destroy                    | 无                                                           | `void`                                 | 销毁画布（覆盖，清除文本编辑管理器） |
| discardActiveObject        | `e?: TPointerEvent`                                          | `this is Object`                       | 丢弃激活对象（触发事件）             |
| dispose                    | 无                                                           | `Promise<boolean>`                     | 销毁画布（等待渲染完成）             |
| drawClipPathOnCanvas       | `ctx: CanvasRenderingContext2D`, `clipPath: TCachedFabricObject` | `void`                                 | 绘制剪裁路径                         |
| drawControls               | `ctx: CanvasRenderingContext2D`                              | `void`                                 | 绘制控件                             |
| endCurrentTransform        | `e?: TPointerEvent`                                          | `void`                                 | 结束当前变换                         |
| findNewLowerIndex          | `object: FabricObject`, `idx: number`, `intersecting?: boolean` | `number`                               | 查找新下层索引                       |
| findNewUpperIndex          | `object: FabricObject`, `idx: number`, `intersecting?: boolean` | `number`                               | 查找新上层索引                       |
| findTarget                 | `e: TPointerEvent`                                           | `undefined \| FabricObject`            | 查找目标对象                         |
| fire                       | `eventName: K`, `options?: CanvasEvents[K]`                  | `void`                                 | 触发事件                             |
| forEachObject              | `callback: (object, index, array) => void`                   | `void`                                 | 遍历对象                             |
| get                        | `property: string`                                           | `any`                                  | 获取属性                             |
| getActiveObject            | 无                                                           | `undefined \| FabricObject`            | 获取激活对象                         |
| getActiveObjects           | 无                                                           | `FabricObject[]`                       | 获取激活对象数组                     |
| getCenter                  | 无                                                           | `object { left: number, top: number }` | 获取中心坐标                         |
| getCenterPoint             | 无                                                           | `Point`                                | 获取中心点                           |
| getContext                 | 无                                                           | `CanvasRenderingContext2D`             | 获取上下文                           |
| getElement                 | 无                                                           | `HTMLCanvasElement`                    | 获取元素                             |
| getHeight                  | 无                                                           | `number`                               | 获取高度                             |
| getObjects                 | `...types?: string[]`                                        | `FabricObject[]`                       | 获取对象数组                         |
| getPointer                 | `e: TPointerEvent`, `fromViewport?: boolean`                 | `Point`                                | 获取指针坐标                         |
| getScenePoint              | `e: TPointerEvent`                                           | `Point`                                | 获取场景点                           |
| getSelectionContext        | 无                                                           | `CanvasRenderingContext2D`             | 获取选择上下文                       |
| getSelectionElement        | 无                                                           | `HTMLCanvasElement`                    | 获取选择元素                         |
| getTopContext              | 无                                                           | `CanvasRenderingContext2D`             | 获取顶部上下文                       |
| getViewportPoint           | `e: TPointerEvent`                                           | `Point`                                | 获取视口点                           |
| getVpCenter                | 无                                                           | `Point`                                | 获取视口中心                         |
| getWidth                   | 无                                                           | `number`                               | 获取宽度                             |
| getZoom                    | 无                                                           | `number`                               | 获取缩放级别                         |
| insertAt                   | `index: number`, `...objects: FabricObject[]`                | `number`                               | 在索引处插入对象                     |
| isEmpty                    | 无                                                           | `boolean`                              | 是否为空                             |
| isTargetTransparent        | `target: FabricObject`, `x: number`, `y: number`             | `boolean`                              | 目标是否透明                         |
| item                       | `index: number`                                              | `FabricObject`                         | 获取指定索引对象                     |
| loadFromJSON               | `json: string \| Record<string, any>`, `reviver?`, `options?: Abortable` | `Promise<Canvas>`                      | 从 JSON 加载                         |
| moveObjectTo               | `object: FabricObject`, `index: number`                      | `boolean`                              | 移动对象到指定层                     |
| off                        | 多种重载（eventName, handler 等）                            | `void`                                 | 移除事件监听                         |
| on                         | 多种重载（eventName, handler 等）                            | `VoidFunction`                         | 添加事件监听                         |
| once                       | 多种重载（eventName, handler 等）                            | `VoidFunction`                         | 添加一次性事件监听                   |
| relativePan                | `point: Point`                                               | `void`                                 | 相对平移                             |
| removeListeners            | 无                                                           | `void`                                 | 移除所有监听                         |
| renderAll                  | 无                                                           | `void`                                 | 渲染所有                             |
| renderCanvas               | `ctx: CanvasRenderingContext2D`, `objects: FabricObject[]`   | `void`                                 | 渲染画布                             |
| renderTop                  | 无                                                           | `void`                                 | 渲染顶部层                           |
| renderTopLayer             | `ctx: CanvasRenderingContext2D`                              | `void`                                 | 渲染顶部层（文本选择）               |
| requestRenderAll           | 无                                                           | `void`                                 | 请求渲染所有                         |
| searchPossibleTargets      | `objects?: FabricObject[]`, `pointer?: Point`                | `undefined \| FabricObject`            | 搜索可能目标                         |
| sendObjectBackwards        | `object: FabricObject`, `intersecting?: boolean`             | `boolean`                              | 后移对象                             |
| sendObjectToBack           | `object: FabricObject`                                       | `boolean`                              | 移到最后                             |
| set                        | `key: string \| Record<string, any>`, `value?: any`          | `Canvas`                               | 设置属性                             |
| setActiveObject            | `object: FabricObject`, `e?: TPointerEvent`                  | `boolean`                              | 设置激活对象                         |
| setCursor                  | `value: string`                                              | `void`                                 | 设置光标                             |
| setDimensions              | 多种重载（dimensions, options）                              | `void`                                 | 设置尺寸                             |
| setHeight                  | 多种重载（value, options）                                   | `void`                                 | 设置高度                             |
| setViewportTransform       | `vpt: TMat2D`                                                | `void`                                 | 设置视口变换                         |
| setWidth                   | 多种重载（value, options）                                   | `void`                                 | 设置宽度                             |
| setZoom                    | `value: number`                                              | `void`                                 | 设置缩放                             |
| size                       | 无                                                           | `number`                               | 获取大小                             |
| toCanvasElement            | `multiplier?: number`, `options?: TToCanvasElementOptions`   | `HTMLCanvasElement`                    | 转换为 canvas 元素                   |
| toDataURL                  | `options?: TDataUrlOptions`                                  | `string`                               | 转换为 Data URL                      |
| toDatalessJSON             | `propertiesToInclude?: string[]`                             | `any`                                  | 转换为无数据 JSON                    |
| toDatalessObject           | `propertiesToInclude?: string[]`                             | `any`                                  | 转换为无数据对象                     |
| toJSON                     | 无                                                           | `any`                                  | 转换为 JSON                          |
| toObject                   | `propertiesToInclude?: string[]`                             | `any`                                  | 转换为对象                           |
| toSVG                      | `options?: TSVGExportOptions`, `reviver?: TSVGReviver`       | `string`                               | 转换为 SVG                           |
| toString                   | 无                                                           | `string`                               | 转换为字符串                         |
| toggle                     | `property: string`                                           | `Canvas`                               | 切换属性                             |

**补充说明**：方法大多用于渲染、事件处理和对象管理。渲染相关方法如 `renderAll()` 是核心，建议在修改后调用以更新视图。事件方法（如 `on`、`off`）支持自定义事件。序列化方法（如 `toJSON`、`loadFromJSON`）用于保存/加载画布状态。注意：一些方法如 `dispose` 是异步的，以确保渲染完成。文档基于 FabricJS 源代码，实际使用时参考官方示例。